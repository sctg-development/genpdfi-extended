name: CI

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        shell: bash
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup default stable
          rustup component add rustfmt clippy
        env:
          CARGO_HOME: ${{ runner.temp }}/cargo_home

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin --locked

      - name: Build
        run: cargo build --all-features --verbose

      - name: Run tests (default features)
        run: cargo test --verbose

      - name: Install Python deps for visual tests
        run: python3 -m pip install --upgrade pip && python3 -m pip install -r tests/scripts/requirements.txt

      - name: Run tests (images feature)
        env:
          CI_VISUAL_STRICT: "1"
        run: cargo test --all-features --verbose

      - name: Generate coverage (Tarpaulin)
        continue-on-error: true
        run: cargo tarpaulin --out Xml --output-dir coverage --all-features --skip wrap::tests::test_wrapper_overflow_sets_flag stdout

      - name: Upload cobertura artifact
        uses: actions/upload-artifact@v4
        with:
          name: cobertura
          path: coverage/cobertura.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/cobertura.xml
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          CODECOV_SLUG: sctg-development/genpdfi-extended

  docs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        shell: bash
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup default stable
          rustup install nightly
          rustup component add rustfmt clippy
        env:
          CARGO_HOME: ${{ runner.temp }}/cargo_home
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Build docs
        run: RUSTDOCFLAGS="-Z unstable-options --static-root-path /genpdfi-extended/" cargo +nightly doc --all-features --document-private-items --no-deps

      - name: Patch docs for GitHub project pages
        shell: bash
        run: |
          set -euo pipefail
          REPO=$(basename "$GITHUB_REPOSITORY")
          ROOT=target/doc
          DOCDIR="$ROOT/$REPO"
          echo "Doc dir: $DOCDIR"
          # Copy common global assets into crate doc dir if present (JS, CSS, WASM, fonts)
          shopt -s nullglob
          for f in "$ROOT"/crates.js "$ROOT"/main-*.js "$ROOT"/settings-*.js "$ROOT"/main-*.css "$ROOT"/normalize-*.css "$ROOT"/rustdoc-*.css "$ROOT"/storage-*.js "$ROOT"/*.wasm "$ROOT"/*.woff2; do
            if [ -f "$f" ]; then
              echo "Copying $f to $DOCDIR/"
              cp -v "$f" "$DOCDIR"/
            fi
          done
          # Also copy font files found in subdirectories
          find "$ROOT" -type f -name '*.woff2' -exec cp -v {} "$DOCDIR"/ \; || true

          # Fix absolute references in HTML/CSS/JS to point to project root
          # Replace occurrences like "/crates.js" -> "/<repo>/crates.js", "/main-" -> "/<repo>/main-", and handle url('/...') patterns
          grep -RIl -e '"/crates.js' -e '"/main-' -e '"/normalize-' -e '"/rustdoc-' -e '"/storage-' -e 'SourceSerif4-' -e 'FiraSans-' -e 'SourceCodePro-' "$DOCDIR" || true
          for file in $(grep -RIl -e '"/crates.js' -e '"/main-' -e '"/normalize-' -e '"/rustdoc-' -e '"/storage-' -e 'SourceSerif4-' -e 'FiraSans-' -e 'SourceCodePro-' "$DOCDIR" || true); do
            sed -i 's|"/crates.js|"/'"$REPO"'/crates.js|g' "$file"
            sed -i 's|"/main-|"/'"$REPO"'/main-|g' "$file"
            sed -i 's|"/normalize-|"/'"$REPO"'/normalize-|g' "$file"
            sed -i 's|"/rustdoc-|"/'"$REPO"'/rustdoc-|g' "$file"
            sed -i 's|"/storage-|"/'"$REPO"'/storage-|g' "$file"
            sed -i 's|"/SourceSerif4-|"/'"$REPO"'/SourceSerif4-|g' "$file"
            sed -i 's|"/FiraSans-|"/'"$REPO"'/FiraSans-|g' "$file"
            sed -i 's|"/SourceCodePro-|"/'"$REPO"'/SourceCodePro-|g' "$file"
            sed -i 's|href="/|href="/'"$REPO"'/|g' "$file"
            sed -i 's|src="/|src="/'"$REPO"'/|g' "$file"
            sed -i "s|url('/|url('/$REPO/|g" "$file"
            sed -i "s|url(\"/|url(\"/$REPO/|g" "$file"
            sed -i 's|url(/|url(/'"$REPO"'/|g' "$file"
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: target/doc/genpdfi_extended
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
